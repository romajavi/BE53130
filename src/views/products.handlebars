<div class="linea-horizontal"></div>

<div class="menu-container">
  <div class="logo">
    <a href="/">
      <img src="/img/2.png" alt="Logo de la empresa">
    </a>
  </div>
  <div class="menu">
    <span class="separator">|</span>
    <a href="/realtimeproducts" class="menu-item">Productos en Tiempo Real</a>
    <span class="separator">|</span>
    <a href="/chat" class="menu-item">Chat en Vivo</a>
    <span class="separator">|</span>
    <a href="/profile" class="menu-item">Perfil</a>
    <span class="separator">|</span>
    <a href="/logout" class="menu-item">Cerrar Sesión</a>
    <span class="separator">|</span>
  </div>
</div>

<div class="userBienvenida">
  {{#if user}}
  <p>Bienvenido, {{user.email}}!</p>
  <p>Rol: {{user.role}}</p>
  {{/if}}
</div>

<div class="carrito">
  <a id="cart-link" href="/carts/{{cartId}}">
    <i class="fas fa-shopping-cart"></i>
    <span id="cart-counter">{{cartCounter}}</span>
  </a>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/carts/get-cart-id')
      .then(response => response.json())
      .then(data => {
        if (data.cartId) {
          document.getElementById('cart-link').setAttribute('href', '/carts/' + data.cartId);
        }
      })
      .catch(error => console.error('Error al obtener el ID del carrito:', error));

    const addToCartForms = document.querySelectorAll('.add-to-cart-form');
    addToCartForms.forEach(form => {
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        const productId = form.dataset.productId;
        const quantity = form.querySelector('input[name="quantity"]').value;
        fetch(`/api/carts/${data.cartId}/products/${productId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ quantity: parseInt(quantity, 10) })
        })
        .then(response => response.json())
        .then(data => {
          const cartCounter = document.getElementById('cart-counter');
          const currentCount = parseInt(cartCounter.textContent, 10) || 0;
          cartCounter.textContent = currentCount + parseInt(quantity, 10);
        })
        .catch(error => console.error('Error al agregar el producto al carrito:', error));
      });
    });
  });
</script>

<h1>Productos</h1>


<div id="contenedorProductos">
  {{#each products}}
  <div class="product-card">
    <h3>{{this.title}}</h3>
    <br>
    <p>{{this.description}}</p>
    <p>Precio: ${{this.price}}</p>
    <p>Categoría: {{this.category}}</p>
    <input type="number" class="quantity-input" value="1" min="1" max="{{this.stock}}" data-id="{{this._id}}">
    <br>
    <button class="add-to-cart" data-id="{{this._id}}"
      onclick="addToCart('{{this._id}}', document.querySelector('.quantity-input[data-id=\'{{this._id}}\']').value)">Agregar
      al carrito</button>
  </div>
  {{/each}}
</div>

<div class="pagination">
  {{#if hasPrevPage}}
  <a href="/products?page={{prevPage}}&limit={{limit}}">Anterior</a>
  {{/if}}

  <span>Página {{page}} de {{totalPages}}</span>

  {{#if hasNextPage}}
  <a href="/products?page={{nextPage}}&limit={{limit}}">Siguiente</a>
  {{/if}}
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/main.js"></script>
<link rel="stylesheet" href="/css/styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script>
  const cartId = '{{cartId}}'; 
</script>
<script>
  async function updateCartCount() {
    try {
      const response = await fetch(`/api/carts/{{cartId}}`);
      if (response.ok) {
        const cart = await response.json();
        const totalQuantity = cart.products.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cartCount').textContent = totalQuantity;
      }
    } catch (error) {
      console.error('Error al obtener la cantidad de productos en el carrito:', error);
    }
  }

  updateCartCount();
</script>
