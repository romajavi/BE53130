<div class="linea-horizontal"></div>

<div class="menu-container">
    <div class="logo">
        <a href="/">
            <img src="/img/2.png" alt="Logo de la empresa">
        </a>
    </div>
    <div class="menu">
        <span class="separator">|</span>
        <a href="/chat" class="menu-item">Chat en Vivo</a>
        <span class="separator">|</span>
        <a href="/profile" class="menu-item">Perfil</a>
        <span class="separator">|</span>
        <a href="/logout" class="menu-item">Cerrar Sesi√≥n</a>
        <span class="separator">|</span>
    </div>
</div>

<div class="cart-file">
    <h2>Carrito de compras</h2>

    {{#if cart.products.length}}
    <ul>
        {{#each cart.products}}
        <li>
            <h3>{{this.product.title}}</h3>
            <p>Precio: ${{this.product.price}}</p>
            <p>Cantidad: {{this.quantity}}</p>
            <form class="delete-form" data-cart-id="{{../cart._id}}" data-product-id="{{this.product._id}}">
                <input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="remove-item">Eliminar</button>
            </form>
        </li>
        {{/each}}
    </ul>

    <p>Total de productos: {{cart.products.length}}</p>
    <p>Precio total: ${{totalPrice}}</p>

    <form action="/api/carts/{{cart._id}}/empty" method="POST">
        <button type="submit">Vaciar Carrito</button>
    </form>

    <form action="/api/orders/create" method="POST">
        <input type="hidden" name="cartId" value="{{cart._id}}">
        <button type="submit">Finalizar Compra</button>
    </form>


    {{else}}
    <p>No hay productos en el carrito.</p>
    {{/if}}
</div>

<button><a href="/products" class="botones">Volver a la Tienda</a></button>

<script>
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cartId = form.dataset.cartId;
            const productId = form.dataset.productId;
            const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                form.closest('li').remove();
                updateCartTotals();
            }
        });
    });

    function updateCartTotals() {
        const totalProducts = document.querySelectorAll('ul li').length;
        const totalPrice = Array.from(document.querySelectorAll('ul li'))
            .reduce((total, li) => {
                const price = parseFloat(li.querySelector('p:nth-child(2)').textContent.split('$')[1]);
                const quantity = parseInt(li.querySelector('p:nth-child(3)').textContent.split(': ')[1]);
                return total + (price * quantity);
            }, 0);
        document.querySelector('p:nth-last-child(4)').textContent = `Total de productos: ${totalProducts}`;
        document.querySelector('p:nth-last-child(3)').textContent = `Precio total: $${totalPrice.toFixed(2)}`;
    }
</script>


<link rel="stylesheet" href="/css/styles.css">